rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function: Check if user is admin
    function isAdmin() {
      return request.auth != null && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    // Helper function: Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // USERS COLLECTION
    match /users/{userId} {
      // Anyone can read their own user document
      allow read: if isAuthenticated() && request.auth.uid == userId;

      // Only the user themselves can update their own document (except role field)
      allow update: if isAuthenticated() &&
                       request.auth.uid == userId &&
                       request.resource.data.role == resource.data.role; // Can't change own role

      // Only admins can read all users
      allow read: if isAdmin();

      // Admins can update all users
      allow update: if isAdmin();

      // New users can create their own document during signup
      allow create: if isAuthenticated() && request.auth.uid == userId;
    }
    
    // COMPLEXES COLLECTION
    match /complexes/{complexId} {
      // Admins can do everything
      allow read, write: if isAdmin();
      
      // Tenants can read complexes (to see their complex info)
      allow read: if isAuthenticated();
    }
    
    // UNITS COLLECTION  
    match /units/{unitId} {
      // Admins can do everything
      allow read, write: if isAdmin();
      
      // Tenants can read units (to see their unit info)
      allow read: if isAuthenticated();
    }
    
    // MAINTENANCE REQUESTS COLLECTION
    match /maintenance_requests/{requestId} {
      // Tenants can create maintenance requests
      allow create: if isAuthenticated() && 
                       request.resource.data.tenantId == request.auth.uid;
      
      // Tenants can read their own requests
      allow read: if isAuthenticated() && 
                     resource.data.tenantId == request.auth.uid;
      
      // Tenants can update and delete their own requests (only if not resolved)
      allow update, delete: if isAuthenticated() && 
                               resource.data.tenantId == request.auth.uid &&
                               resource.data.status != 'resolved';
      
      // Admins can read and update all requests
      allow read, update: if isAdmin();
    }
    
    // PAYMENTS COLLECTION
    match /payments/{paymentId} {
      // Tenants can read their own payments (using email)
      allow read: if isAuthenticated() && 
                     resource.data.tenantEmail == request.auth.token.email;
      
      // Admins can read all payments
      allow read: if isAdmin();
      
      // Only server (via API) can create payments
      // Users cannot directly create payment documents
    }

    // PAYMENT VERIFICATIONS COLLECTION
    match /payment_verifications/{verificationId} {
      // Tenants can create verification requests
      allow create: if isAuthenticated() &&
                       request.resource.data.tenantId == request.auth.uid;

      // Tenants can read their own verification requests
      allow read: if isAuthenticated() &&
                     resource.data.tenantId == request.auth.uid;

      // Admins can read and update all verification requests
      allow read, update: if isAdmin();
    }

    // Deny all other access by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
